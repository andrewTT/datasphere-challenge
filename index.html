<!DOCTYPE html>
<html lang="en">
 <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <title>LocalSaver: Your best source for local coupons</title>
  
  <link rel="shortcut icon" href="//cdn.localsaver.com/img/favicon.ico" type="image/x-icon" />
  <link rel="icon" href="//cdn.localsaver.com/img/favicon.ico" type="image/ico" />
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="//fonts.googleapis.com/css?family=Open+Sans:400,600,300">
  
  <style type="text/css">
	body{
		font-family: 'Open Sans', Helvetica, Tahoma, sans-serif;
	}
	h1{
		font-size: 48px; 
	}
	h2{
		font-size: 26px;
	}
	#header{
		background: #097ab3;
		padding: 15px 0px;
		font-size: 18px;
	}
	.row.no-gutters > [class^="col-"], .row.no-gutters > [class*=" col-"]{
		padding-right: 0px;
		padding-left: 0px;
	}
	#deals .panel-heading{
		background-image: none;
		background: #fff;
	}
	#deals .panel-body{
		padding: 0px;
	}
	#deals .location{
		font-size: 16px;
		font-weight: 700;
	}
	#deals .deal-image{
		border-bottom: 1px solid #ddd;
	}
	#deals .deal-body{
		padding: 15px;
	}
	#deals .deal-logo{
		padding: 2px;
		margin-top: -75px;
	}
	#deals .deal-category{
		text-align: left;
		font-size: 16px;
		font-weight: 700;
	}
	#deals .badge{
		background: #097ab3;
		color: #fff;
	}
	#deals .well{
		background: #097ab3;
		color: #fff;
		font-size: 18px;
		font-weight: 700;
		margin-top: 15px;
	}
	#deals .list-group{
		-webkit-box-shadow: none;
		box-shadow: none;
	}
	#deals .list-group-item{
		border: 0px;
		border-top: 1px solid #ddd;
		text-align: left;
	}
	#deals .list-group-item i{
		color: #666;
		font-size: 2em;
	}
	
	#deals .deal-coupon{
		border: 0px;
		border-top: 1px solid #ddd;
		text-align: left;
		margin: 10px auto 0px;
	}
	#deals .deal-coupon i{
		color: #666;
		font-size: 2em;
	}
  </style>
 </head>
 <body>
  
	<div class="container-fluid text-center">
	
		<div class="row no-gutters">
			<div class="col-xs-12">
				<div id="header">
					<img src="images/localsaver-logo.png" alt="Local Saver" />
				</div>
			</div>
		</div>
		
		<div class="row">
			<div class="col-xs-12">
				<h1>Coupons &amp; Deals near You</h1>
				<h2 class="text-muted">+3,600 Matches Found</h2>
			</div>
		</div>
		
		<div class="row" id="deals">
		
			<div class="col-xs-12 col-sm-6 col-md-4 deal" data-deal-id>
				<div class="panel panel-default">
					<div class="panel-heading">
						<span class="location pull-left" data-deal-location><i class="fa fa-map-marker"></i> Bellevue, WA</span>
						<span class="distance pull-right" data-deal-distance>3.3 mi</span>
						<div class="clearfix"></div>
					</div>
					<div class="panel-body">
						<div class="deal-image">
							<img src="images/tile1-main.jpg" alt="" class="img-responsive" />
						</div>
						<div class="deal-body">
							<div class="row">
								<div class="col-xs-5">
									<img src="images/tile1-logo.jpg" alt="" class="deal-logo img-thumbnail" />
								</div>
								<div class="col-xs-7 deal-category" data-deal-category>Nutritionists</div>
							</div>
							<div class="deal-business-name well" data-deal-business-name>Sound Nourishment Nutritional Counseling</div>
							<div class="deal-coupons">
								<div class="row deal-coupon">
									<div class="col-xs-10" data-coupon-value>20% off Regular Price for Cash-Paying Clients</div>
									<div class="col-xs-2"><i class="fa fa-angle-right pull-right"></i></div>
								</div>
								<div class="row deal-coupon">
									<div class="col-xs-10">Refer a Friend, Get 25% Off Next Visit</div>
									<div class="col-xs-2"><i class="fa fa-angle-right pull-right"></i></div>
								</div>
							</div>
						
						</div>
					</div>
				</div>
			</div>
			
			<div class="clearfix visible-xs-block"></div>
			
			<div class="col-xs-12 col-sm-6 col-md-4 deal" data-deal-id>
				<div class="panel panel-default">
					<div class="panel-heading">
						<span class="location pull-left" data-location><i class="fa fa-map-marker"></i> Seattle, WA</span>
						<span class="distance pull-right" data-distance>12.9 mi</span>
						<div class="clearfix"></div>
					</div>
					<div class="panel-body">
						<div class="deal-image">
							<img src="images/tile2-main.jpg" alt="" class="img-responsive" />
						</div>
						<div class="deal-body">
							<div class="row">
								<div class="col-xs-5">
									<img src="images/tile2-logo.jpg" alt="" class="deal-logo img-thumbnail" />
								</div>
								<div class="col-xs-7 deal-category" data-deal-category>Indian Resturaunts</div>
							</div>
							<div class="deal-business-name well" data-deal-business-name>Maharaja Cusine of India</div>
							<div class="deal-coupons">
								<div class="row deal-coupon">
									<div class="col-xs-10">$15 certificate for $6, A 60% Savings!</div>
									<div class="col-xs-2"><i class="fa fa-angle-right pull-right"></i></div>
								</div>
								<div class="row deal-coupon">
									<div class="col-xs-10">$25 certificate for $10, A 60% Savings!</div>
									<div class="col-xs-2"><i class="fa fa-angle-right pull-right"></i></div>
								</div>
							</div>
							<p class="text-primary">See All <span class="badge">4</span></p>
						</div>
					</div>
				</div>
			</div>
			
			<div class="clearfix visible-xs-block visible-sm-block"></div>
			
			<div class="col-xs-12 col-sm-6 col-md-4 deal" data-deal-id>
				<div class="panel panel-default">
					<div class="panel-heading">
						<span class="location pull-left" data-location><i class="fa fa-map-marker"></i> Seattle, WA</span>
						<span class="distance pull-right" data-distance>8.4 mi</span>
						<div class="clearfix"></div>
					</div>
					<div class="panel-body">
						<div class="deal-image">
							<img src="images/tile3-main.jpg" alt="" class="img-responsive" />
						</div>
						<div class="deal-body">
							<div class="row">
								<div class="col-xs-5">
									<img src="images/tile3-logo.jpg" alt="" class="deal-logo img-thumbnail" />
								</div>
								<div class="col-xs-7 deal-category" data-deal-category>Toy Store</div>
							</div>
							<div class="deal-business-name well" data-deal-business-name>Toys R Us</div>
							<div class="deal-coupons">
								<div class="row deal-coupon">
									<div class="col-xs-10">15% OFF all Bathtubs &amp; Bath Accessories</div>
									<div class="col-xs-2"><i class="fa fa-angle-right pull-right"></i></div>
								</div>
								<div class="row deal-coupon">
									<div class="col-xs-10">20% OFF all Humidifiers, Vaporizers &amp; Air Purifiers</div>
									<div class="col-xs-2"><i class="fa fa-angle-right pull-right"></i></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			
			<div class="clearfix visible-xs-block visible-md-block visible-lg-block"></div>
			
		</div>
		
		<div id="loading">Loading... <i class="fa fa-refresh fa-spin"></i></div>
		
	</div>
 </body>
 
 <script src="//code.jquery.com/jquery-2.1.4.min.js"></script>
 <script>
	var userData = {page: 1, thisLoop: 0};
	$(document).ready(function(){
		var fetchResults = function(){
			$.ajax({
				url: "http://codingchallenge.datasphere.com:8084/getbusinesses/",
				dataType: "jsonp",
				data:{
					location: this.latitude + "," + this.longitude,
					pg: this.page,
					pz: 10,
					callback: "results"
				},
				success: function(response){
					userData.page++;
					userData.businesses = response.businesses;
					userData.isNextPage = response.nextPage;
					userData.count = response.count;
					populateDeals.call(userData);
				}
			});
		},
		setPosition = function(pos){
			userData.latitude = pos.coords.latitude;
			userData.longitude = pos.coords.longitude;
			if (!userData.latitude){
				alert("Error Getting Location");
				return;
			}
			fetchResults.call(userData);
		},
		positionError = function(err){
			//geolocation didn't work or isn't supported
		},
		populateDeals = function(){
		 if (!this.businesses){
		  alert("No More Results");
		  return;
		 }
		 
		 $.each(this.businesses, function(i, obj){
			userData.thisLoop++;
			var deal = $("#deals").children().first().clone(),
		    clearfix = "<div class='clearfix visible-xs-block'></div>";
			deal.find("[data-deal-business-name]").html(obj.businessname);
			deal.find("[data-deal-location]").html(obj.city + ", " + obj.state);
			deal.find("[data-deal-distance]").html(obj.distance + " mi");
			deal.find("[data-deal-category]").html(obj.category);
			for (var a = 0; a >= 1; a++){
				deal.find("[data-coupon-value]").html(obj.coupons[a].title);
			}
			if (obj.coupons.length > 2){
			 $("<p class='text-primary'>See All <span class='badge'>" + obj.coupons.length + "</span></p>").insertAfter(deal.find(".deal-coupons"));
			}
			
			$("#loading").hide();
			$("#deals").append(deal);
			if (userData.thisLoop === 1){
				$("#deals").append($(clearfix));
			}else if (userData.thisLoop === 2){
				$("#deals").append($(clearfix).addClass("visible-sm-block"));
			}else if (userData.thisLoop === 3){
				$("#deals").append($(clearfix).addClass("visible-md-block visible-lg-block"));
				userData.thisLoop = 0;
			}else{
				userData.thisLoop = 0;
			}
		 });
		};
   
		if ("geolocation" in navigator){
			navigator.geolocation.getCurrentPosition(setPosition, positionError, {timeout:5000});
		}
		
		$(window).on('scroll', function(){
			if (userData.page > 1){
				if ($(window).scrollTop() >= $(document).height() - $(window).height()){
					$("#loading").show();
					fetchResults.call(userData);
				}
			}
		});
	});
 </script>
</html>